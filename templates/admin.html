{% extends 'base.html' %}
{% block content %}
<section class="card">
  <div class="card-header between">
    <h2>Admin</h2>
    <span id="wsstate" class="badge">connecting…</span>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="orders">Orders</button>
    <button class="tab" data-tab="books">Books</button>
  </div>

  <div class="tab-panels">
    <!-- ORDERS PANEL -->
    <div class="tab-panel active" id="panel-orders">
      <div class="tabs" style="margin-top:8px">
        <button class="tab active" data-subtab="pending">Pending ({{ pending|length }})</button>
        <button class="tab" data-subtab="approved">Approved ({{ approved|length }})</button>
        <button class="tab" data-subtab="cancelled">Cancelled ({{ cancelled|length }})</button>
      </div>
      <div class="tab-panels">
        <div class="tab-panel active" id="sub-pending">
          <div class="table-responsive">
            <table class="table">
              <thead><tr><th>ID</th><th>Khách</th><th>Phone</th><th>Sách</th><th>SL</th><th>Tổng</th><th>Thời gian</th><th></th></tr></thead>
              <tbody>
              {% for o in pending %}
                <tr>
                  <td>{{o.order_id}}</td><td>{{o.customer_name}}</td><td>{{o.phone}}</td>
                  <td>{{o.title}}</td><td>{{o.quantity}}</td><td>{{ "{:,.0f}".format(o.total) }}đ</td><td>{{o.created_at}}</td>
                  <td class="actions">
                    <button class="btn btn-approve" onclick="approve({{o.order_id}})">Duyệt</button>
                    <button class="btn btn-cancel" onclick="cancelOrder({{o.order_id}})">Hủy</button>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-panel" id="sub-approved">
          <div class="table-responsive">
            <table class="table">
              <thead><tr><th>ID</th><th>Khách</th><th>Phone</th><th>Sách</th><th>SL</th><th>Tổng</th><th>Thời gian</th></tr></thead>
              <tbody>
              {% for o in approved %}
                <tr>
                  <td>{{o.order_id}}</td><td>{{o.customer_name}}</td><td>{{o.phone}}</td>
                  <td>{{o.title}}</td><td>{{o.quantity}}</td><td>{{ "{:,.0f}".format(o.total) }}đ</td><td>{{o.created_at}}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="tab-panel" id="sub-cancelled">
          <div class="table-responsive">
            <table class="table">
              <thead><tr><th>ID</th><th>Khách</th><th>Phone</th><th>Sách</th><th>SL</th><th>Tổng</th><th>Thời gian</th></tr></thead>
              <tbody>
              {% for o in cancelled %}
                <tr>
                  <td>{{o.order_id}}</td><td>{{o.customer_name}}</td><td>{{o.phone}}</td>
                  <td>{{o.title}}</td><td>{{o.quantity}}</td><td>{{ "{:,.0f}".format(o.total) }}đ</td><td>{{o.created_at}}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- BOOKS PANEL -->
<div class="tab-panel" id="panel-books">
  <div class="card-body">
    <div class="toolbar between stack-sm">
      <div class="title-wrap">
        <h3 class="h3">Quản lý Sách</h3>
        <p class="muted small">Thêm/sửa sách sẽ cập nhật ngay giao diện & chatbot.</p>
      </div>
      <button class="btn btn-primary" id="btn-add-book" type="button">
        <span class="btn-dot"></span>Thêm sách
      </button>
    </div>

    <div class="table-wrap pretty">
      <table class="table pretty" id="books-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tiêu đề</th>
            <th>Tác giả</th>
            <th>Giá</th>
            <th>Tồn</th>
            <th>Thể loại</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for b in books %}
          <tr data-id="{{ b.book_id }}">
            <td class="c-id">{{ b.book_id }}</td>
            <td class="c-title">{{ b.title }}</td>
            <td class="c-author">{{ b.author }}</td>
            <td class="c-price">{{ b.price }}</td>
            <td class="c-stock">{{ b.stock }}</td>
            <td class="c-category">{{ b.category }}</td>
            <td class="actions">
              <button class="btn btn-sm btn-ghost btn-edit" type="button">Sửa</button>
              <button class="btn btn-sm btn-danger btn-delete" type="button">Xoá</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

    <!-- CHATS PANEL (mới) -->
    <div class="tab-panel" id="panel-chats">
    <div class="chats-wrap">
      <aside class="chats-list">
        <div class="chats-toolbar">
          <input id="chat-search" placeholder="Tìm theo session id..." />
          <button class="btn" id="chat-search-btn">Tìm</button>
        </div>
        <ul id="chat-sessions"></ul>
      </aside>
      <section class="chats-view">
        <div class="chats-header">
          <div>Session: <code id="chat-current-sid">—</code></div>
          <div class="muted" id="chat-meta">Chọn một session để xem lịch sử</div>
        </div>
        <div class="chatlog" id="chatlog"></div>
      </section>
    </div>
  </div>
  </div>
</section>

<!-- MODAL: thêm/sửa sách -->
<div class="modal" id="book-modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="book-modal"></div>

  <div class="modal-card elevated max-w-720">
    <div class="card-header between">
      <h3 id="book-modal-title">Thêm sách</h3>
      <button class="btn btn-ghost" type="button" data-close="book-modal" aria-label="Đóng">✕</button>
    </div>

    <form class="card-body" id="book-form" autocomplete="off">
      <input type="hidden" id="book-id">

      <div class="form-grid">
        <div class="ui-field">
          <input id="book-title" placeholder=" " required>
          <label for="book-title">Tiêu đề</label>
          <small class="hint">Tên sách hiển thị cho khách hàng</small>
        </div>

        <div class="ui-field">
          <input id="book-author" placeholder=" " required>
          <label for="book-author">Tác giả</label>
        </div>

        <div class="ui-field">
          <input id="book-price" inputmode="numeric" placeholder=" " required>
          <label for="book-price">Giá (VND)</label>
          <small class="hint">Chỉ nhập số, không dấu phẩy</small>
        </div>

        <div class="ui-field">
          <input id="book-stock" inputmode="numeric" placeholder=" " required>
          <label for="book-stock">Tồn kho</label>
        </div>

        <div class="ui-field span-2">
          <input id="book-category" placeholder=" " required>
          <label for="book-category">Thể loại</label>
        </div>
      </div>

      <div class="right gap-8 mt-12">
        <button class="btn" type="button" data-close="book-modal">Huỷ</button>
        <button class="btn btn-primary" type="submit" id="book-submit">
          <span class="spinner" hidden></span>
          <span>Lưu</span>
        </button>
      </div>

      <p class="muted mt-8" id="book-hint"></p>
    </form>
  </div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/js/admin.js" defer></script>
<script src="/static/js/book.js" defer></script>
<script src="/static/js/admin_chats.js" defer></script>
{% endblock %}
